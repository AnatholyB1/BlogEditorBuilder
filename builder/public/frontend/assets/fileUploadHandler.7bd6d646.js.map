{"version":3,"file":"fileUploadHandler.7bd6d646.js","sources":["../../../../node_modules/frappe-ui/src/utils/fileUploadHandler.ts"],"sourcesContent":["interface UploadOptions {\n  private?: boolean\n  folder?: string\n  file_url?: string\n  doctype?: string\n  docname?: string\n  fieldname?: string\n  method?: string\n  type?: string\n  upload_endpoint?: string\n}\n\ntype EventListenerOption = 'start' | 'progress' | 'finish' | 'error'\n\ndeclare global {\n  interface Window {\n    csrf_token?: string\n  }\n}\n\nclass FileUploadHandler {\n  listeners: { [event: string]: Function[] }\n  failed: boolean\n\n  constructor() {\n    this.listeners = {}\n    this.failed = false\n  }\n\n  on(event: EventListenerOption, handler: Function) {\n    this.listeners[event] = this.listeners[event] || []\n    this.listeners[event].push(handler)\n  }\n\n  trigger(event: string, data?: any) {\n    let handlers = this.listeners[event] || []\n    handlers.forEach((handler) => {\n      handler.call(this, data)\n    })\n  }\n\n  upload(file: File | null, options: UploadOptions): Promise<any> {\n    return new Promise((resolve, reject) => {\n      let xhr = new XMLHttpRequest()\n      xhr.upload.addEventListener('loadstart', () => {\n        this.trigger('start')\n      })\n      xhr.upload.addEventListener('progress', (e) => {\n        if (e.lengthComputable) {\n          this.trigger('progress', {\n            uploaded: e.loaded,\n            total: e.total,\n          })\n        }\n      })\n      xhr.upload.addEventListener('load', () => {\n        this.trigger('finish')\n      })\n      xhr.addEventListener('error', () => {\n        this.trigger('error')\n        reject()\n      })\n      xhr.onreadystatechange = () => {\n        if (xhr.readyState == XMLHttpRequest.DONE) {\n          let error\n          if (xhr.status === 200) {\n            let r = null\n            try {\n              r = JSON.parse(xhr.responseText)\n            } catch (e) {\n              r = xhr.responseText\n            }\n            let out = r.message || r\n            resolve(out)\n          } else if (xhr.status === 403) {\n            error = JSON.parse(xhr.responseText)\n          } else {\n            this.failed = true\n            try {\n              error = JSON.parse(xhr.responseText)\n            } catch (e) {\n              // pass\n            }\n          }\n          if (error && error.exc) {\n            console.error(JSON.parse(error.exc)[0])\n          }\n          reject(error)\n        }\n      }\n\n      const uploadEndpoint =\n        options.upload_endpoint || '/api/method/upload_file'\n      xhr.open('POST', uploadEndpoint, true)\n      xhr.setRequestHeader('Accept', 'application/json')\n\n      if (window.csrf_token && window.csrf_token !== '{{ csrf_token }}') {\n        xhr.setRequestHeader('X-Frappe-CSRF-Token', window.csrf_token)\n      }\n\n      let form_data = new FormData()\n      if (file) {\n        form_data.append('file', file, file.name)\n      }\n      form_data.append('is_private', options.private || false ? '1' : '0')\n      form_data.append('folder', options.folder || 'Home')\n\n      if (options.file_url) {\n        form_data.append('file_url', options.file_url)\n      }\n\n      if (options.doctype && options.docname) {\n        form_data.append('doctype', options.doctype)\n        form_data.append('docname', options.docname)\n        if (options.fieldname) {\n          form_data.append('fieldname', options.fieldname)\n        }\n      }\n\n      if (options.method) {\n        form_data.append('method', options.method)\n      }\n\n      if (options.type) {\n        form_data.append('type', options.type)\n      }\n\n      xhr.send(form_data)\n    })\n  }\n}\n\nexport default FileUploadHandler\n"],"names":["FileUploadHandler","__publicField","event","handler","data","file","options","resolve","reject","xhr","e","error","r","out","uploadEndpoint","form_data"],"mappings":"wKAoBA,MAAMA,CAAkB,CAItB,aAAc,CAHdC,EAAA,kBACAA,EAAA,eAGE,KAAK,UAAY,GACjB,KAAK,OAAS,EAChB,CAEA,GAAGC,EAA4BC,EAAmB,CAChD,KAAK,UAAUD,GAAS,KAAK,UAAUA,IAAU,GAC5C,KAAA,UAAUA,GAAO,KAAKC,CAAO,CACpC,CAEA,QAAQD,EAAeE,EAAY,EAClB,KAAK,UAAUF,IAAU,CAAA,GAC/B,QAASC,GAAY,CACpBA,EAAA,KAAK,KAAMC,CAAI,CAAA,CACxB,CACH,CAEA,OAAOC,EAAmBC,EAAsC,CAC9D,OAAO,IAAI,QAAQ,CAACC,EAASC,IAAW,CAClC,IAAAC,EAAM,IAAI,eACVA,EAAA,OAAO,iBAAiB,YAAa,IAAM,CAC7C,KAAK,QAAQ,OAAO,CAAA,CACrB,EACDA,EAAI,OAAO,iBAAiB,WAAaC,GAAM,CACzCA,EAAE,kBACJ,KAAK,QAAQ,WAAY,CACvB,SAAUA,EAAE,OACZ,MAAOA,EAAE,KAAA,CACV,CACH,CACD,EACGD,EAAA,OAAO,iBAAiB,OAAQ,IAAM,CACxC,KAAK,QAAQ,QAAQ,CAAA,CACtB,EACGA,EAAA,iBAAiB,QAAS,IAAM,CAClC,KAAK,QAAQ,OAAO,EACbD,GAAA,CACR,EACDC,EAAI,mBAAqB,IAAM,CACzB,GAAAA,EAAI,YAAc,eAAe,KAAM,CACrC,IAAAE,EACA,GAAAF,EAAI,SAAW,IAAK,CACtB,IAAIG,EAAI,KACJ,GAAA,CACEA,EAAA,KAAK,MAAMH,EAAI,YAAY,QACxBC,GACPE,EAAIH,EAAI,YACV,CACI,IAAAI,EAAMD,EAAE,SAAWA,EACvBL,EAAQM,CAAG,CAAA,SACFJ,EAAI,SAAW,IAChBE,EAAA,KAAK,MAAMF,EAAI,YAAY,MAC9B,CACL,KAAK,OAAS,GACV,GAAA,CACME,EAAA,KAAK,MAAMF,EAAI,YAAY,QAC5BC,GAET,CACF,CACIC,GAASA,EAAM,KACjB,QAAQ,MAAM,KAAK,MAAMA,EAAM,GAAG,EAAE,EAAE,EAExCH,EAAOG,CAAK,CACd,CAAA,EAGI,MAAAG,EACJR,EAAQ,iBAAmB,0BACzBG,EAAA,KAAK,OAAQK,EAAgB,EAAI,EACjCL,EAAA,iBAAiB,SAAU,kBAAkB,EAE7C,OAAO,YAAc,OAAO,aAAe,oBACzCA,EAAA,iBAAiB,sBAAuB,OAAO,UAAU,EAG3D,IAAAM,EAAY,IAAI,SAChBV,GACFU,EAAU,OAAO,OAAQV,EAAMA,EAAK,IAAI,EAE1CU,EAAU,OAAO,aAAcT,EAAQ,QAAmB,IAAM,GAAG,EACnES,EAAU,OAAO,SAAUT,EAAQ,QAAU,MAAM,EAE/CA,EAAQ,UACAS,EAAA,OAAO,WAAYT,EAAQ,QAAQ,EAG3CA,EAAQ,SAAWA,EAAQ,UACnBS,EAAA,OAAO,UAAWT,EAAQ,OAAO,EACjCS,EAAA,OAAO,UAAWT,EAAQ,OAAO,EACvCA,EAAQ,WACAS,EAAA,OAAO,YAAaT,EAAQ,SAAS,GAI/CA,EAAQ,QACAS,EAAA,OAAO,SAAUT,EAAQ,MAAM,EAGvCA,EAAQ,MACAS,EAAA,OAAO,OAAQT,EAAQ,IAAI,EAGvCG,EAAI,KAAKM,CAAS,CAAA,CACnB,CACH,CACF"}